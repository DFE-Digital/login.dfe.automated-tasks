# login.dfe.automated-tasks

Automated tasks run on schedules or triggered manually to carry out BAU activities for DfE Sign-in.

## DevOps Requirements

TBD

## Local Debugging

To ease local running/debugging of these functions, please install the recommended VSCode extensions:

- [Azure Functions](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)
- [Azurite](https://marketplace.visualstudio.com/items?itemName=Azurite.azurite) (alternatively, you can download [Azurite via npm](https://learn.microsoft.com/en-gb/azure/storage/common/storage-use-azurite?tabs=npm%2Cblob-storage) but the instructions below are for the VSCode extension)

### First time setup

1. Open the command palette (`F1` or `ctrl + shift + p`) in VSCode and run the "Azure Functions: Install or Update Azure Functions Core Tools" command to install the tools required to run the function locally.
2. Create a `local.settings.json` file in the root directory (ignored by git) with the following default settings:
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "DeactivateUnusedAccountsTimer": "0 0 0 1 * *"
  },
  "ConnectionStrings": {}
}
```

### Running any functions locally

1. Adjust the `local.settings.json` file to fit the environment you are debugging against:

| Setting | Description | How to update | Default value |
|   ---   |     ---     |      ---      |      ---      |
| DeactivateUnusedAccountsTimer | The NCronTab expression that sets the schedule for the deactivateUnusedAccounts function (`./src/functions/deactivateUnusedAccounts`). | Read the [documentation on NCrontab formatting](https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=python-v2%2Cisolated-process%2Cnodejs-v4&pivots=programming-language-typescript#ncrontab-expressions) and use a [tester](https://ncrontab.swimburger.net/) to verify your expression runs as you'd expect. | `0 0 0 1 * *` Runs at 12AM UTC on the first day of every month. |

2. Start the Azurite storage emulator using the "Azurite: Start" command from the command palette (`F1` or `ctrl + shift + p`) as the functions need somewhere to write their state that mimics Azure's storage when deployed.
3. Open the "Run and Debug" menu in VSCode, select "Attach to Node functions" if it isn't selected by default, and click the start debugging button, this does the following:
    - Start Typescript's watch mode to update the functions when changes are made.
    - Start the local Azure Functions runtime, showing their output in the terminal. The functions will appear in the Azure tab of your VSCode, under "Workspace > Local Project > Functions" and allows you to manually kick off a run there by right clicking the function and choosing "Execute Function Now".
4. Do your testing/debugging!
5. Once you're finished, you can stop the functions by either alt-clicking the detach/disconnect button in the debug bar that floats on your screen (or click the little drop-down beside it and click "Stop") or terminating the running terminals in VSCode and detaching the debugger.
6. To stop Azurite, run "Azurite: Close" from the command palette. The files generated by Azurite are in the `.gitignore` file but if you would like to clean them, run "Azurite: Clean" which will attempt to clear the files it generated.
