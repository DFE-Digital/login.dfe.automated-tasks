# login.dfe.automated-tasks

Automated tasks run on schedules or triggered manually to carry out BAU activities for DfE Sign-in.

- [login.dfe.automated-tasks](#logindfeautomated-tasks)
  - [DevOps Requirements](#devops-requirements)
  - [Local Debugging](#local-debugging)
    - [First time setup](#first-time-setup)
    - [Running any functions locally](#running-any-functions-locally)
  - [Adding New Database Connections](#adding-new-database-connections)
  - [Adding New DSi Internal API Connections](#adding-new-dsi-internal-api-connections)

## DevOps Requirements

TBD

## Local Debugging

To ease local running/debugging of these functions, please install the recommended VSCode extensions:

- [Azure Functions](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)
- [Azurite](https://marketplace.visualstudio.com/items?itemName=Azurite.azurite) (alternatively, you can download [Azurite via npm](https://learn.microsoft.com/en-gb/azure/storage/common/storage-use-azurite?tabs=npm%2Cblob-storage) but the instructions below are for the VSCode extension)

### First time setup

1. Open the command palette (`F1` or `ctrl + shift + p`) in VSCode and run the "Azure Functions: Install or Update Azure Functions Core Tools" command to install the tools required to run the function locally.
2. Create a `local.settings.json` file in the root directory (ignored by git) with the following default settings:
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "DeactivateUnusedAccountsTimer": "0 0 0 1 * *",
    "DEBUG": "true",
    "DATABASE_DIRECTORIES_HOST": "",
    "DATABASE_DIRECTORIES_NAME": "",
    "DATABASE_DIRECTORIES_USERNAME": "",
    "DATABASE_DIRECTORIES_PASSWORD": "",
    "API_INTERNAL_DIRECTORIES_HOST": "",
    "API_INTERNAL_TENANT": "",
    "API_INTERNAL_AUTHORITY_HOST": "",
    "API_INTERNAL_CLIENT_ID": "",
    "API_INTERNAL_CLIENT_SECRET": "",
    "API_INTERNAL_RESOURCE": "",
    "AUDIT_CONNECTION_STRING": "",
    "AUDIT_TOPIC_NAME": "audit"
  },
  "ConnectionStrings": {}
}
```

### Running any functions locally

1. Adjust the `local.settings.json` file to fit the environment you are debugging against using the table below these steps.
2. Start the Azurite storage emulator using the "Azurite: Start" command from the command palette (`F1` or `ctrl + shift + p`) as the functions need somewhere to write their state that mimics Azure's storage when deployed.
3. Open the "Run and Debug" menu in VSCode, select "Attach to Node functions" if it isn't selected by default, and click the start debugging button, this does the following:
    - Start Typescript's watch mode to update the functions when changes are made.
    - Start the local Azure Functions runtime, showing their output in the terminal. The functions will appear in the Azure tab of your VSCode, under "Workspace > Local Project > Functions" and allows you to manually kick off a run there by right clicking the function and choosing "Execute Function Now".
4. Do your testing/debugging!
5. Once you're finished, you can stop the functions by either alt-clicking the detach/disconnect button in the debug bar that floats on your screen (or click the little drop-down beside it and click "Stop") or terminating the running terminals in VSCode and detaching the debugger.
6. To stop Azurite, run "Azurite: Close" from the command palette. The files generated by Azurite are in the `.gitignore` file but if you would like to clean them, run "Azurite: Clean" which will attempt to clear the files it generated.

| Setting | Description | How to update | Default value |
|   ---   |     ---     |      ---      |      ---      |
| DeactivateUnusedAccountsTimer | The NCronTab expression that sets the schedule for the deactivateUnusedAccounts function (`./src/functions/deactivateUnusedAccounts`). | Read the [documentation on NCrontab formatting](https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=python-v2%2Cisolated-process%2Cnodejs-v4&pivots=programming-language-typescript#ncrontab-expressions) and use a [tester](https://ncrontab.swimburger.net/) to verify your expression runs as you'd expect. | `0 0 0 1 * *` Runs at 12AM UTC on the first day of every month. |
| DEBUG | Turns on additional logging to assist with debugging issues. | Simple toggle, change to `false` to disable additional logging. | `true` |
| DATABASE_DIRECTORIES_HOST | The directories database hostname/URL. | Retrieve from KeyVault or other database connections. | `""`
| DATABASE_DIRECTORIES_NAME | The directories database name | Retrieve from KeyVault or other database connections. | `""`
| DATABASE_DIRECTORIES_USERNAME | SQL username for connecting to the directories database. | Use your own username or retrieve from KeyVault. | `""`
| DATABASE_DIRECTORIES_PASSWORD | SQL password for connecting to the directories database. | Use your own password or retrieve from KeyVault. | `""`
| API_INTERNAL_DIRECTORIES_HOST | Host URL for the internal directories API. | Retrieve from KeyVault or the "Domains" section of the app service's "Overview" page in the Azure portal. | `""`
| API_INTERNAL_TENANT | Tenant ID of the internal API tenant. | Retrieve from KeyVault. | `""`
| API_INTERNAL_AUTHORITY_HOST | Authority host URL of the internal API tenant. | Retrieve from KeyVault. | `""`
| API_INTERNAL_CLIENT_ID | Client ID of the internal API tenant. | Retrieve from KeyVault. | `""`
| API_INTERNAL_CLIENT_SECRET | Client secret of the internal API tenant. | Retrieve from KeyVault. | `""`
| API_INTERNAL_RESOURCE | Resource ID of the internal API tenant. | Retrieve from KeyVault. | `""`
| AUDIT_CONNECTION_STRING | Connection string of the environment's shared service bus. | Retrieve from KeyVault or the service bus' "Shared access policies" page in the Azure portal. | `""`
| AUDIT_TOPIC_NAME | Service bus audit topic name. | Retrieve from KeyVault or the service bus' "Overview" page in the Azure portal. | `"audit"`

## Adding New Database Connections

1. Add an additional value to the `DatabaseName` enum within `src/infrastructure/database/common/connection.ts` e.g. `Foo = "foo"`.
2. Add app settings/environment variables to the app and your `local.settings.json` named using the database name in capitals, the following is using the `"foo"` example:
   - `DATABASE_FOO_HOST`
   - `DATABASE_FOO_NAME`
   - `DATABASE_FOO_USERNAME`
   - `DATABASE_FOO_PASSWORD`
3. Update the blank `local.settings.json` in step 2 of the ["First time setup"](#first-time-setup) section above.
4. Add descriptions to the table in step 1 of the ["Running any functions locally"](#running-any-functions-locally) section above.

## Adding New DSi Internal API Connections

1. Add an additional value to the `ApiName` enum within `src/infrastructure/api/dsiInternal/DsiInternalApiClient.ts` e.g. `Foo = "foo"`.
2. Add an app setting/environment variable for the API's URL to the app and your `local.settings.json` file named using the API name in capitals, the following is using the `"foo"` example:
   - `API_INTERNAL_FOO_HOST`
3. Update the blank `local.settings.json` in step 2 of the ["First time setup"](#first-time-setup) section above.
4. Add a description to the table in step 1 of the ["Running any functions locally"](#running-any-functions-locally) section above.
